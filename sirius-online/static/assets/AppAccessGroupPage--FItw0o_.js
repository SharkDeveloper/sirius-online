import{a as K,u as be,i as Ce,b as J,c as o,d as he,bd as Oe,be as Ge,bf as Re,o as g,e as R,w as S,f as q,g as u,h as a,j as Se,k as Ne,v as Te,$ as Ie,bg as M,n as k,m as F,p as ye,aG as Ue,bh as ze,bi as Le,q as De,r as H,s as xe,l as Q,T as ke,F as Fe,bj as X,bk as we,A as Be}from"./app-X261GMLD.js";import{_ as Pe,A as $,a as W}from"./AppConfigFormHeader-CpKOoRvu.js";import{u as Ze,g as Ve,a as je}from"./useConfigForm-Dwead9lM.js";import{u as qe}from"./useConfigDialog-CoOncFYH.js";import{p as Me}from"./parseZoneRights-Ct1Qguht.js";import{A as He}from"./AppDragAndDropArea-Cr3Xjs1I.js";const Qe={class:"config-form__body"},Xe={class:"config-form__buttons"},$e={__name:"AppAccessGroupForm",props:{elements:{type:Array,default:()=>[]}},emits:["update:elements"],setup(w,{emit:_}){const{showDeleteDialog:A,showOkDialog:d,showDescribedDialog:v}=qe(),l=K(),E=Ue(),{t:N}=be(),T=Ce("rightTree"),b=w,C=_,i=J(),I=o(()=>i.getters["access_group/accessGroupArray"]),y=o(()=>i.getters["access_group/accessGroupsWithConfigureAccess"]),f=o(()=>i.getters["user/userArray"]),p=o(()=>i.getters["zone/ZONE_LIST"]),U=o(()=>i.getters["zone_group/ZONE_GROUP_LIST"]),h=o(()=>i.getters["zone/zoneArray"]),O=o(()=>i.getters["zone_group/zoneGroupArray"]),m=o(()=>({zone:p.value,zone_group:U.value})),{form:n,formRef:Y,deleteButtonRef:ee,isSaving:z,onSave:te,isDeleting:L,onDelete:se,isNew:B,mainFormElement:D,deleteButtonLabel:ae,saveButtonLabel:ne,onReset:oe}=Ze({props:b,saveFn:pe,deleteFn:me,resetFn:re});function re({form:e,mainFormElement:t}){e.value=he(Oe(le(t)))}function le(e){return{...e.value,zone_access_rights:e.value.zone_access_rights.reduce((t,s)=>{const{rights:r,index:c,type:x}=Me(s),G=m.value[x][c];return G&&t.set(G.number,{rights:r,isNew:!1}),t},new Map)}}function ie(){const e=Array.from(n.value.zone_access_rights.entries()).map(([t,{rights:s}])=>{const r=[...h.value,...O.value].find(G=>G.number===t),c=r.elementType==="zone_group"?ze:0,x=ce(s);return[r.index+c,parseInt(x.reverse().join(""),2)]});for(;e.length!==32;)e.push([Le,0]);return{...n.value,zone_access_rights:e}}const P=o({get:()=>Array.from(n.value.zone_access_rights.keys()),set:e=>{const t=Array.from(n.value.zone_access_rights.keys());t.forEach(s=>{e.includes(s)||n.value.zone_access_rights.delete(s)}),e.forEach(s=>{t.includes(s)||n.value.zone_access_rights.set(s,[])}),e.length>t.length&&j().then(s=>{e.forEach(r=>{t.includes(r)||n.value.zone_access_rights.set(r,{rights:s,isNew:!0})})})}});function ue(e,t){const s=e.type==="zone_group",r=t.type==="zone_group";return s&&!r?-1:!s&&r?1:e.data.number-t.data.number}function ce(e){const t=new Array(16).fill(0);return e.forEach(s=>{t[s]=1}),t}const Z=o(()=>Object.values(y.value).filter(e=>e.index!==D.value.index&&f.value.findIndex(t=>t.access_group_index===e.index)!==-1).length===0),de=o(()=>Z.value&&!n.value.admin_access_rights.includes(0));function V({title:e}){d(e,l.value.CONFIGURATION.ACCESS_GROUPS.requiredAccessGroup)}async function pe(){if(de.value){V(l.value.CONFIGURATION.ACCESS_GROUPS.CANNOT_ADDING_MODAL);return}const e=ie();return z.value=!0,await i.dispatch("config/saveElement",{data:e,type:"access_group"}),C("update:elements",[e]),!0}async function me(){if(Z.value){V(l.value.CONFIGURATION.ACCESS_GROUPS.CANNOT_DELETE_DIALOG);return}const e=n.value.index,t=f.value.filter(c=>c.access_group_index===e),{title:s,subtitle:r}=l.value.CONFIGURATION.ACCESS_GROUPS.DELETE_DIALOG;if(t.length>0){if(!await v(A,s,r,t))return}else if(!await A(s))return;return L.value=!0,await i.dispatch("config/deleteElement",{index:e,type:"access_group",stash:!0}),await i.dispatch("config/integrityCheck"),!0}const ge=o(()=>Ve(I.value,"name",D.value.index)),_e=o(()=>[{label:l.value.CONFIGURATION.ACCESS_GROUPS.LABEL.panelConfiguration,value:0},{label:l.value.CONFIGURATION.ACCESS_GROUPS.LABEL.updateConfiguration,value:1},{label:l.value.CONFIGURATION.ACCESS_GROUPS.LABEL.commissioning,value:2}]),fe=o(()=>Ge.map(e=>({value:e,label:l.value.CONFIGURATION.ACCESS_GROUPS.ZONE_ACCESS_RIGHTS[e]})));async function j(e=[]){return new Promise(t=>{E.create({component:Re,componentProps:{title:l.value.CONFIGURATION.ACCESS_GROUPS.ZONE_ACCESS_RIGHTS_SELECTION_TITLE.title,modelValue:e,options:fe.value}}).onOk(s=>{t(s)}).onDismiss(()=>{t(e)})})}function Ae(e,t){return e.sort((s,r)=>s-r).join(",")===t.sort((s,r)=>s-r).join(",")}function ve(e){const{rights:t}=n.value.zone_access_rights.get(e);j(t).then(s=>{Ae(t,s)||n.value.zone_access_rights.set(e,{rights:s,isNew:!0})})}const Ee=o(()=>Array.from(Object.values(T.value).flat().values()).map(e=>{var t;return{...e,editable:!0,isNew:(t=n.value.zone_access_rights.get(e.data.number))==null?void 0:t.isNew}}));return(e,t)=>(g(),R(ye,{class:"config-form",ref_key:"formRef",ref:Y,onSubmit:a(te),onReset:a(oe)},{default:S(()=>[q("div",Qe,[u(Pe,{title:a(D).filledName,"onUpdate:elements":t[0]||(t[0]=s=>C("update:elements",s))},null,8,["title"]),u($,{label:a(l).CONFIGURATION.DEVICES.mainSettings},{default:S(()=>[u(Se,{modelValue:a(n).name,"onUpdate:modelValue":t[1]||(t[1]=s=>a(n).name=s),modelModifiers:{trim:!0},"data-testid":"name-input",label:a(l).GENERAL.LABEL.name+" *",rules:[...a(Ne),s=>a(Te).string().notIn(ge.value).required().validate(s)],maxlength:"31",class:"b-field",required:""},null,8,["modelValue","label","rules"])]),_:1},8,["label"]),u($,{label:a(l).CONFIGURATION.ACCESS_GROUPS.LABEL.adminAccessRights},{default:S(()=>[u(Ie,{modelValue:a(n).admin_access_rights,"onUpdate:modelValue":t[2]||(t[2]=s=>a(n).admin_access_rights=s.sort((r,c)=>r-c)),options:_e.value,color:"primary",type:"checkbox","data-testid":"admin-access-rights-group","left-label":"",class:"b-option-group-checkbox"},null,8,["modelValue","options"])]),_:1},8,["label"]),u(a(He),{modelValue:P.value,"onUpdate:modelValue":t[3]||(t[3]=s=>P.value=s),label:a(l).CONFIGURATION.ACCESS_GROUPS.LABEL.zonesAccessRights,items:Ee.value,type:["zone","zone_group"],compareItems:ue,hint:a(N)("config.accessGroup.maxRightsCount",{count:a(M)}),"max-count":a(M),onEditItem:ve,"data-key":"number",itemMarker:"extendedMarker","data-testid":"zone-access-rights-dnd"},null,8,["modelValue","label","items","hint","max-count"])]),q("div",Xe,[a(B)?F("",!0):(g(),R(k,{key:0,label:a(l).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),a(B)?F("",!0):(g(),R(k,{key:1,ref_key:"deleteButtonRef",ref:ee,label:a(ae),loading:a(L),disable:a(z),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:a(se)},null,8,["label","loading","disable","onClick"])),u(k,{loading:a(z),label:a(ne),disable:a(L),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["loading","label","disable"])])]),_:1},8,["onSubmit","onReset"]))}},st={__name:"AppAccessGroupPage",setup(w){const _=K(),{maxElementsToast:A}=je(),d=J(),v=o(()=>d.getters["access_group/ACCESS_GROUP_TREE"]),l=o(()=>d.getters["access_group/accessGroupArray"]),E=o(()=>({zone:d.getters["zone/ZONE_TREE"],zone_group:d.getters["zone_group/ZONE_GROUP_TREE"]})),{formId:N,leftTreeRef:T,selectedElements:b,selectedTreeItemIds:C,selectNewTreeItemIds:i,updateSelectedElements:I,onAdd:y}=De({leftTree:v,rightTree:E,add:U}),f=o(()=>[{name:"zone",label:_.value.GENERAL.LABEL.zones},{name:"zone_group",label:_.value.GENERAL.LABEL.zoneGroups}]),p=H();xe(()=>{p.value=f.value[0].name});function U(){if(l.value.length>=X){A(X);return}return we({...Be("access_group"),index:null})}const h=H([]);return(O,m)=>(g(),Q(Fe,null,[u(a(W),{ref_key:"leftTreeRef",ref:T,selected:a(C),"onUpdate:selected":a(i),onAdd:a(y),items:v.value,title:a(_).ROUTER.CONFIG.accessGroups,"required-selection":"",searchable:"","add-button":""},null,8,["selected","onUpdate:selected","onAdd","items","title"]),a(b).length?(g(),R(ke,{key:0,name:"fade",mode:"out-in"},{default:S(()=>[(g(),Q("div",{class:"config-form-wrapper",key:a(N)},[u(a($e),{elements:a(b),"onUpdate:elements":a(I)},null,8,["elements","onUpdate:elements"])]))]),_:1})):F("",!0),u(a(W),{tab:p.value,"onUpdate:tab":m[0]||(m[0]=n=>p.value=n),selected:h.value,"onUpdate:selected":m[1]||(m[1]=n=>h.value=n),items:E.value[p.value],tabs:f.value,"is-right-tree":"","can-multiple-selection":"","can-selection-all-children":"",searchable:""},null,8,["tab","selected","items","tabs"])],64))}};export{st as default};
