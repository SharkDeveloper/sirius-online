import{B as gt,u as ze,a as ce,b as pe,c as o,C as yt,S as Be,d as Pe,o as y,e as I,w as K,f as te,g as m,h as e,D as nt,G as st,j as se,k as Ae,Q as oe,v as Ie,m as R,H as _t,l as re,n as h,p as Oe,i as Me,r as ae,I as Nt,J as ie,N as _e,K as de,L as Tt,U as It,O as At,P as be,R as Ot,V as ot,W as xt,F as Fe,X as je,Y as Ke,Z as Ne,$ as Rt,a0 as Ze,a1 as Lt,s as it,a2 as Qe,_ as Xe,a3 as Ut,a4 as Ct,t as ut,T as rt,a5 as Ye,a6 as He,a7 as Ge,a8 as Je,a9 as We,q as Dt,aa as Vt,ab as ke,y as St,ac as kt,A as Bt}from"./app-X261GMLD.js";import{_ as Ee,A as ue,a as et}from"./AppConfigFormHeader-CpKOoRvu.js";import{u as xe,f as we,g as he,_ as Re,a as Ft,b as Gt}from"./AppChannelForm-gd4iHyJV.js";import{u as Le}from"./useConfigDialog-CoOncFYH.js";import{g as me}from"./getUpdatedElement-DO3HsR5I.js";import{u as ge,g as zt,a as dt}from"./useConfigForm-Dwead9lM.js";import{_ as Pt}from"./AppInputInfinityTime-DnuVbfNN.js";import{_ as tt}from"./AppInputNumber-pcfWNGSA.js";import{A as fe}from"./AppDragAndDropArea-Cr3Xjs1I.js";import{r as Mt}from"./range-_Bp7Yin7.js";import"./AppInputNumberWithCheckbox-C-TLkeux.js";async function mt(z,$){const c=gt();let r=[];if(c.getters[`${$}/${$}Array`].forEach(g=>{z.find(S=>S.number===g.number&&S.device_index===g.device_index)&&r.push(g)}),r.length)return await c.dispatch("config/deleteElement",{elementList:r.map(g=>({index:g.index,type:$})),stash:!0})}const wt={class:"config-form__body"},ht={key:0,class:"config-form__buttons"},ct={__name:"AppInputForm",props:{elements:{type:Array,default:()=>[]},closable:{type:Boolean,default:!1}},emits:["update:elements","close","replace"],setup(z,{emit:$}){const{t:c}=ze(),r=ce(),f=pe(),g=z,S=$,{form:a,formRef:k,deleteButtonRef:w,isSaving:P,onSave:O,isDeleting:F,onDelete:B,isNew:_,isMultipleEditing:L,mainFormElement:l,deleteButtonLabel:J,saveButtonLabel:q,onReset:j}=ge({props:g,saveFn:ne,deleteFn:X,resetFn:Q}),{isReadonly:U,isReplaceable:M,isBelongKdlDevice:W,isAttachedZonePt:x,checkMaxElements:n}=xe(l),{confirmElementsDeletion:b,confirmDuplicateContactId:N}=Le(),V=o(()=>yt(a.value)),T=o(()=>f.getters["device/DEVICE_LIST"]),G=o(()=>f.getters["script/mainScriptsByType"]),Z=o(()=>[{label:r.value.CONFIGURATION.GENERAL.notSetParentheses,value:255},...Object.values(G.value[Be.INPUT]).map(C=>({label:C.formattedName,value:C.index,number:C.script_number})).sort((C,E)=>C.number-E.number)]),ee=o(()=>Object.entries(r.value.CONFIGURATION.INPUTS.INPUTS_TYPES).map(([C,E])=>({label:E,value:Number(C)})));function Q({form:C,mainFormElement:E,isMultipleEditing:p}){if(p.value){C.value=we(g.elements);return}C.value=Pe(E.value)}async function ne(){const C=me(a.value),E=g.elements.map(le=>me({...le,...C}));if(!n(E,"input")||H.value&&!await N())return;P.value=!0;const p=T.value[C.device_index];return p!=null&&p.isKDL&&await mt(E,"output"),await f.dispatch("config/saveElement",{elementList:E.map(le=>({data:le,type:le.elementType}))}),S("update:elements",E),!0}async function X(){const C=[...g.elements],E=await b(C);if(E)return F.value=!0,await f.dispatch("config/deleteElement",{elementList:E.map(p=>({index:p.index,type:p.elementType}))}),!0}const Y=o(()=>he("input",a.value.index)),H=o(()=>Y.value.includes(a.value.contact_id));return(C,E)=>(y(),I(Oe,{class:"config-form",ref_key:"formRef",ref:k,onSubmit:e(O),onReset:e(j)},{default:K(()=>[te("div",wt,[m(Ee,{title:e(nt)(e(l)),marker:e(st)(e(l)).extendedMarker,onClose:E[0]||(E[0]=p=>S("close")),closable:z.closable,"element-type":e(l).elementType,"show-element-type":e(W),replaceable:e(M),onReplace:E[1]||(E[1]=p=>S("replace",e(a),"output")),"multiple-editing":e(L),elements:z.elements,"onUpdate:elements":E[2]||(E[2]=p=>S("update:elements",p))},null,8,["title","marker","closable","element-type","show-element-type","replaceable","multiple-editing","elements"]),m(ue,{label:e(r).CONFIGURATION.DEVICES.mainSettings},{default:K(()=>[m(se,{modelValue:e(a).name,"onUpdate:modelValue":E[3]||(E[3]=p=>e(a).name=p),modelModifiers:{trim:!0},label:e(r).GENERAL.LABEL.name,rules:e(Ae),disable:V.value||e(U),maxlength:"31",class:"b-field","data-testid":"name-input"},null,8,["modelValue","label","rules","disable"]),m(oe,{modelValue:e(a).type,"onUpdate:modelValue":E[4]||(E[4]=p=>e(a).type=p),label:e(r).GENERAL.LABEL.type,options:ee.value,disable:e(U)||V.value,"popup-content-class":"b-select-popup",class:"b-field","emit-value":"","map-options":"","data-testid":"type-select"},null,8,["modelValue","label","options","disable"]),m(Re,{modelValue:e(a).zone_index,"onUpdate:modelValue":E[5]||(E[5]=p=>e(a).zone_index=p),label:e(r).GENERAL.LABEL.zone,disable:e(U)||V.value,"include-zones-pt":e(x),"popup-content-class":"b-select-popup",class:"b-field","exclude-alien-zones":""},null,8,["modelValue","label","disable","include-zones-pt"]),e(L)?R("",!0):(y(),I(se,{key:0,modelValue:e(a).contact_id,"onUpdate:modelValue":E[6]||(E[6]=p=>e(a).contact_id=p),modelModifiers:{number:!0},min:1,max:999,hint:e(c)("error.range",{min:1,max:999}),rules:[p=>e(Ie).coerce.number().integer().min(1).max(999).validate(p)],disable:V.value,type:"number",label:"Contact ID","data-testid":"contact-id-input",class:"b-field"},null,8,["modelValue","hint","rules","disable"]))]),_:1},8,["label"]),!e(x)&&!V.value&&!e(_t)(e(l))?(y(),I(ue,{key:0,label:e(r).CONFIGURATION.DEVICES.automaticControlSettings},{default:K(()=>[m(oe,{modelValue:e(a).script_index,"onUpdate:modelValue":E[7]||(E[7]=p=>e(a).script_index=p),label:e(r).CONFIGURATION.DEVICES.LABEL.script_index,options:Z.value,disable:e(U),class:"b-field","emit-value":"","map-options":"","data-testid":"script-select"},null,8,["modelValue","label","options","disable"])]),_:1},8,["label"])):R("",!0)]),V.value?R("",!0):(y(),re("div",ht,[e(_)?R("",!0):(y(),I(h,{key:0,label:e(r).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),!e(_)&&!e(U)?(y(),I(h,{key:1,ref_key:"deleteButtonRef",ref:w,label:e(J),loading:e(F),disable:e(P),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(B)},null,8,["label","loading","disable","onClick"])):R("",!0),m(h,{label:e(q),loading:e(P),disable:e(F),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["label","loading","disable"])]))]),_:1},8,["onSubmit","onReset"]))}},$t={class:"config-form__body"},qt={class:"config-form__buttons"},pt={__name:"AppOutputForm",props:{elements:{type:Array,default:()=>[]},closable:{type:Boolean,default:!1}},emits:["update:elements","close","replace"],setup(z,{emit:$}){const{t:c}=ze(),r=Me("rightTree"),f=ce(),g=pe(),S=o(()=>g.getters["device/DEVICE_LIST"]),a=o(()=>g.getters["program/PROGRAM_LIST"]),k=o(()=>g.getters["script/mainScriptsByType"]),{confirmElementsDeletion:w,confirmDuplicateContactId:P}=Le(),O=z,F=$,B=ae(""),_=o(()=>Nt(O.elements[0])),L=o(()=>O.elements.length>1&&!_.value),{form:l,formRef:J,deleteButtonRef:q,isSaving:j,onSave:U,isDeleting:M,onDelete:W,isNew:x,mainFormElement:n,deleteButtonLabel:b,saveButtonLabel:N,onReset:V}=ge({props:O,saveFn:Se,deleteFn:v,resetFn:Ve}),{isReadonly:T,isReplaceable:G,isBelongKdlDevice:Z,isAttachedZonePt:ee,checkMaxElements:Q}=xe(n);function ne(){"program_index"in l.value&&(l.value.program_index=de,l.value.delay1=0,l.value.delay2=0,l.value.activate_time=0,l.value.related_zones=[],l.value.related_zonegroups=[])}function X(){"script_index"in l.value&&(l.value.script_index=_e)}function Y(t){B.value=t,t==="script"?ne():t==="program"&&X()}function H(t){l.value.type=t,t===ie.voiceAlarm&&Y("script")}function C(t){t===de?ne():l.value.program_index=t}const E=o(()=>l.value.type!==ie.voiceAlarm),p=o(()=>{const t=[{label:f.value.GENERAL.LABEL.scenario,value:"script"}];return E.value&&t.unshift({label:f.value.GENERAL.LABEL.program,value:"program"}),t}),le=o(()=>{const t=[];t.push({label:f.value.CONFIGURATION.GENERAL.notSetParentheses,value:_e});const s=l.value.type===ie.voiceAlarm;return t.concat(Object.values(k.value[s?Be.VA:Be.OUTPUT]).map(d=>({label:d.formattedName,value:d.index,number:d.script_number})).sort((d,D)=>d.number-D.number))}),Ue=o(()=>[{label:f.value.CONFIGURATION.GENERAL.notSetParentheses,value:de},...Object.values(a.value).filter(t=>t.number<Tt||t.number>It).map(t=>({label:t.formattedName,value:t.index,number:t.number})).sort((t,s)=>t.number-s.number)]),ve=o(()=>!!g.getters["output/inDamperComposition"](l.value)),Ce=o(()=>ve.value&&!_.value),De=o(()=>{const{OUTPUTS_TYPES:t}=f.value.CONFIGURATION.OUTPUTS;return n.value.type===ie.damper?[{label:t[ie.damper],value:ie.damper}]:Object.entries(t).filter(([d])=>d!=ie.damper).map(([d,D])=>({label:D,value:Number(d)}))});function Ve({form:t,mainFormElement:s,isNew:d}){L.value?(t.value=we(O.elements),t.value.script_index=t.value.script_index??_e,t.value.program_index=t.value.program_index??de):t.value=Pe(s.value),t.value.elements=[],t.value.advancedControlElements=[],_.value&&(d.value?t.value.elements=JSON.parse(JSON.stringify(O.elements.slice(1))):t.value.elements=g.getters["output/getRelatedDamperElements"](t.value),t.value.advancedControlElements=t.value.elements.filter(D=>D.zone_index===s.value.zone_index&&D.zone_index!==At).map(D=>D.uniqueIndex)),B.value=L.value?"":"program","script_index"in t.value&&t.value.script_index!==_e&&(B.value="script"),"program_index"in t.value&&t.value.program_index!==de&&(B.value="program")}async function Se(){const t=me(l.value);let s;if(_.value)s=l.value.elements.map(D=>(l.value.advancedControlElements.includes(D.uniqueIndex)?D.zone_index=t.zone_index:D.zone_index=65535,D)),s.unshift(t);else if(s=O.elements.map(D=>me({...D,...t})),!Q(s,"output"))return;if(bt.value&&!await P())return;j.value=!0;const d=S.value[t.device_index];return d!=null&&d.isKDL&&!_.value&&mt(s,"input"),await g.dispatch("config/saveElement",{elementList:s.map(D=>({data:D,type:D.elementType}))}),_.value?F("update:elements",[s[0]]):F("update:elements",s),!0}async function v(){const t=[...O.elements,...l.value.elements],s=await w(t);if(s)return M.value=!0,await g.dispatch("config/deleteElement",{elementList:s.map(d=>({index:d.index,type:d.elementType}))}),!0}const u=o(()=>{var t;return B.value==="program"&&((t=a.value[l.value.program_index])==null?void 0:t.conditions.some(s=>s.delay===1))});be(u,t=>{t||(l.value.delay1=0)});const i=o(()=>{var t;return B.value==="program"&&((t=a.value[l.value.program_index])==null?void 0:t.conditions.some(s=>s.delay===2))});be(i,t=>{t||(l.value.delay2=0)});const A=o(()=>{var t;return B.value==="program"&&((t=a.value[l.value.program_index])==null?void 0:t.conditions.some(s=>Ot.includes(s.command)))});be(A,t=>{t||(l.value.activate_time=0)});const ye=o(()=>O.elements.every(t=>{var qe;const s=S.value[t.device_index],d=t.number,D=ot(s.type,s.version),$e=(qe=D==null?void 0:D.nums)==null?void 0:qe.driven_output;return $e?$e.some(([ft,Et])=>ft<=d&&d<=Et):!1}));be(()=>l.value.type,()=>{const t=l.value.script_index;le.value.find(s=>s.value===t)||X()},{immediate:!0});const vt=o(()=>he("output",l.value.index)),bt=o(()=>vt.value.includes(l.value.contact_id));return(t,s)=>(y(),I(Oe,{class:"config-form",ref_key:"formRef",ref:J,onSubmit:e(U),onReset:e(V)},{default:K(()=>[te("div",$t,[m(Ee,{title:e(nt)(e(n)),marker:e(st)(e(n)).extendedMarker,onClose:s[0]||(s[0]=d=>F("close")),closable:z.closable,"element-type":e(n).elementType,"show-element-type":e(Z)&&!_.value,replaceable:e(G),"multiple-editing":L.value,elements:z.elements,onReplace:s[1]||(s[1]=d=>F("replace",e(l),"input")),"onUpdate:elements":s[2]||(s[2]=d=>F("update:elements",d))},null,8,["title","marker","closable","element-type","show-element-type","replaceable","multiple-editing","elements"]),m(ue,{label:e(f).CONFIGURATION.DEVICES.mainSettings},{default:K(()=>[ve.value?R("",!0):(y(),I(se,{key:0,modelValue:e(l).name,"onUpdate:modelValue":s[3]||(s[3]=d=>e(l).name=d),modelModifiers:{trim:!0},label:e(f).GENERAL.LABEL.name,rules:e(Ae),disable:e(T),maxlength:"31",class:"b-field","data-testid":"name-input"},null,8,["modelValue","label","rules","disable"])),m(oe,{"model-value":e(l).type,"onUpdate:modelValue":H,label:e(f).GENERAL.LABEL.type,options:De.value,disable:e(T)||ve.value,"popup-content-class":"b-select-popup",class:"b-field","emit-value":"","map-options":"","data-testid":"type-select"},null,8,["model-value","label","options","disable"]),m(Re,{modelValue:e(l).zone_index,"onUpdate:modelValue":s[4]||(s[4]=d=>e(l).zone_index=d),label:e(f).GENERAL.LABEL.zone,disable:e(T),"include-zones-pt":e(ee),"popup-content-class":"b-select-popup",class:"b-field","exclude-alien-zones":""},null,8,["modelValue","label","disable","include-zones-pt"]),L.value?R("",!0):(y(),I(se,{key:1,modelValue:e(l).contact_id,"onUpdate:modelValue":s[5]||(s[5]=d=>e(l).contact_id=d),modelModifiers:{number:!0},min:1,max:999,hint:e(c)("error.range",{min:1,max:999}),rules:[d=>e(Ie).coerce.number().integer().min(1).max(999).validate(d)],type:"number",label:"Contact ID","data-testid":"contact-id-input",class:"b-field"},null,8,["modelValue","hint","rules"]))]),_:1},8,["label"]),ye.value&&!e(T)&&!Ce.value?(y(),I(ue,{key:0,label:e(f).CONFIGURATION.DEVICES.automaticControlSettings},{default:K(()=>[m(xt,{"model-value":B.value,"onUpdate:modelValue":Y,options:p.value,spread:"","no-caps":"","toggle-text-color":"dark-blue","toggle-color":"white","text-color":"color",color:"grey-300",unelevated:"","data-testid":"automatic-control-btn-toggle",class:"b-btn-toggle"},null,8,["model-value","options"]),B.value==="script"?(y(),I(oe,{key:0,modelValue:e(l).script_index,"onUpdate:modelValue":s[6]||(s[6]=d=>e(l).script_index=d),label:e(f).CONFIGURATION.DEVICES.LABEL.script_index,options:le.value,disable:e(T),"popup-content-class":"b-select-popup",class:"b-field","emit-value":"","map-options":"","data-testid":"script-select"},null,8,["modelValue","label","options","disable"])):B.value==="program"?(y(),re(Fe,{key:1},[m(oe,{"model-value":e(l).program_index,"onUpdate:modelValue":C,label:e(f).CONFIGURATION.OUTPUTS.LABEL.program_index,options:Ue.value,"popup-content-class":"b-select-popup",class:"b-field","emit-value":"","map-options":"","data-testid":"program-select"},null,8,["model-value","label","options"]),u.value?(y(),I(tt,{key:0,modelValue:e(l).delay1,"onUpdate:modelValue":s[7]||(s[7]=d=>e(l).delay1=d),min:e(je),max:e(Ke),step:e(Ne),multiple:e(Ne),label:e(f).CONFIGURATION.OUTPUTS.LABEL.delay1,disable:_.value,"data-testid":"delay1-input",required:""},null,8,["modelValue","min","max","step","multiple","label","disable"])):R("",!0),i.value?(y(),I(tt,{key:1,modelValue:e(l).delay2,"onUpdate:modelValue":s[8]||(s[8]=d=>e(l).delay2=d),min:e(je),max:e(Ke),step:e(Ne),multiple:e(Ne),label:e(f).CONFIGURATION.OUTPUTS.LABEL.delay2,disable:_.value,"data-testid":"delay2-input",required:""},null,8,["modelValue","min","max","step","multiple","label","disable"])):R("",!0),A.value?(y(),I(Pt,{key:2,modelValue:e(l).activate_time,"onUpdate:modelValue":s[9]||(s[9]=d=>e(l).activate_time=d),label:e(f).CONFIGURATION.OUTPUTS.LABEL.activate_time,"data-testid":"activate-time"},null,8,["modelValue","label"])):R("",!0),e(l).program_index!==e(de)?(y(),re(Fe,{key:3},[m(e(fe),{modelValue:e(l).related_zones,"onUpdate:modelValue":s[10]||(s[10]=d=>e(l).related_zones=d),label:e(f).CONFIGURATION.OUTPUTS.LABEL.related_zones,items:e(r),type:"zone","data-testid":"related-zones-dnd","data-key":"index",itemMarker:"extendedMarker"},null,8,["modelValue","label","items"]),m(e(fe),{modelValue:e(l).related_zonegroups,"onUpdate:modelValue":s[11]||(s[11]=d=>e(l).related_zonegroups=d),label:e(f).CONFIGURATION.OUTPUTS.LABEL.related_zonegroups,items:e(r),type:"zone_group","data-testid":"related-zonegroups-dnd","data-key":"index",itemMarker:"extendedMarker"},null,8,["modelValue","label","items"])],64)):R("",!0)],64)):R("",!0)]),_:1},8,["label"])):R("",!0),_.value?(y(),I(ue,{key:1,label:e(f).CONFIGURATION.OUTPUTS.LABEL.advancedControl,"close-button":""},{default:K(()=>[m(Rt,{modelValue:e(l).advancedControlElements,"onUpdate:modelValue":s[12]||(s[12]=d=>e(l).advancedControlElements=d),options:e(l).elements,type:"checkbox","data-testid":"advanced-control-checkbox","left-label":"",class:"b-option-group-checkbox","option-value":"uniqueIndex","option-label":"name"},null,8,["modelValue","options"])]),_:1},8,["label"])):R("",!0)]),te("div",qt,[e(x)?R("",!0):(y(),I(h,{key:0,label:e(f).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),!e(x)&&!e(T)?(y(),I(h,{key:1,ref_key:"deleteButtonRef",ref:q,label:e(b),loading:e(M),disable:e(j),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(W)},null,8,["label","loading","disable","onClick"])):R("",!0),m(h,{label:e(N),loading:e(j),disable:e(M),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["label","loading","disable"])])]),_:1},8,["onSubmit","onReset"]))}},jt={class:"config-form__body"},Kt={class:"config-form__buttons"},Te=100,lt=65535,at=4,Zt={__name:"AppDeviceForm",props:{elements:{type:Array,default:()=>[]},closable:{type:Boolean,default:!1}},emits:["update:elements","close"],setup(z,{emit:$}){const c=ce(),{t:r}=ze(),f=z,g=$,S=ae(null),{form:a,formRef:k,deleteButtonRef:w,isSaving:P,onSave:O,isDeleting:F,onDelete:B,isNew:_,mainFormElement:L,onReset:l}=ge({props:f,saveFn:X,deleteFn:Y,resetFn:Q}),{confirmDeviceDeletion:J,confirmSaveCompatibility:q,confirmDuplicateContactId:j}=Le(),{isAttachedZonePt:U}=xe(L),M=pe(),W=o(()=>M.getters["device/deviceArray"]),x=o(()=>M.getters["device/relatedElementsByDeviceIndex"]),n=Me("rightTree"),b=o(()=>{const v=Ze.map(i=>i.type),u=Object.entries(c.value.CONFIGURATION.DEVICES.DEVICE_TYPES).map(([i,A])=>({label:A,value:Number(i)})).sort((i,A)=>i.label.localeCompare(A.label));return v.includes(L.value.type)?u:u.filter(i=>!v.includes(i.value))}),N=o(()=>Object.entries(c.value.CONFIGURATION.DEVICES.TRANSLATE_FORMAT).map(([v,u])=>({label:u,value:Number(v)}))),V=o(()=>Lt[a.value.type]||{}),T=o(()=>{const v=Object.keys(V.value);return v.length?Math.min(...v):0}),G=o(()=>{const v=T.value;return Mt(v,lt+1,1).map(A=>({label:(A/Te).toFixed(2),value:A}))}),Z=ae(G.value);function ee(v,u){u(()=>{const i=v.toLowerCase();Z.value=G.value.filter(A=>A.label.toLowerCase().indexOf(i)>-1)})}function Q({form:v,mainFormElement:u}){v.value=Pe(u.value)}be(()=>T.value,v=>{a.value.version<v&&(a.value.version=v)},{immediate:!0});function ne(v,u){const i=[];if(u)for(const A of Object.values(u).flat())Ct(v.type,v.version,A.elementType,A.number)||i.push(A);return i}async function X(){const v=me(a.value);if(De.value&&!await j())return;const u=x.value[v.index],i=ne(v,u);if(await q(i))return P.value=!0,await M.dispatch("config/saveElement",{data:v,type:"device",stash:!0}),await M.dispatch("config/deleteElement",{elementList:i.map(A=>({index:A.index,type:A.elementType}))}),g("update:elements",[v]),!0}async function Y(){const v=a.value.index;if(!await J(a.value))return;F.value=!0;const u=x.value[v]||{},i=Object.values(u).flat();return await M.dispatch("config/deleteElement",{index:v,type:"device",stash:!0}),await M.dispatch("config/deleteElement",{elementList:i.map(A=>({index:A.index,type:A.elementType}))}),!0}const H=o(()=>Ze.map(v=>v.type).includes(L.value.type)),C=o(()=>!_.value&&L.value.address===at),E=o(()=>_.value&&L.value.address===at),p=ae(!1);it(()=>{const v=ot(a.value.type,a.value.version);if(!v||!Object.hasOwn(v,"translate_format")){a.value.translate_format=Qe.unspecified,a.value.translate_mask=[],a.value.translate_zones=[],a.value.translate_zonegroups=[],p.value=!1;return}a.value.translate_format===Qe.unspecified&&(a.value.translate_format=v.translate_format),p.value=!0});const le=o(()=>C.value&&!Xe?c.value.GENERAL.BUTTON.deactivate:c.value.GENERAL.BUTTON.delete),Ue=o(()=>_.value?E.value&&!Xe?c.value.GENERAL.BUTTON.activate:c.value.GENERAL.BUTTON.add:c.value.GENERAL.BUTTON.save),ve=o(()=>zt(W.value,"address",a.value.index)),Ce=o(()=>he("device",a.value.index)),De=o(()=>Ce.value.includes(a.value.contact_id)),Ve=o(()=>H.value?void 0:r("error.range",{min:5,max:126}));function Se(v){const u=v.target,i=Number(u.value).toFixed(2),A=G.value.findIndex(ye=>ye.label===i);A!==-1&&(a.value.version=G.value[A].value)}return(v,u)=>(y(),I(Oe,{class:"config-form",ref_key:"formRef",ref:k,onSubmit:e(O),onReset:e(l)},{default:K(()=>[te("div",jt,[m(Ee,{title:e(L).filledName,marker:e(L).uniqueIndex,onClose:u[0]||(u[0]=i=>g("close")),closable:z.closable,"onUpdate:elements":u[1]||(u[1]=i=>g("update:elements",i))},null,8,["title","marker","closable"]),m(ue,{label:e(c).CONFIGURATION.DEVICES.mainSettings},{default:K(()=>[m(se,{modelValue:e(a).name,"onUpdate:modelValue":u[2]||(u[2]=i=>e(a).name=i),modelModifiers:{trim:!0},"data-testid":"name-input",label:e(c).GENERAL.LABEL.name,rules:e(Ae),maxlength:"31",class:"b-field"},null,8,["modelValue","label","rules"]),m(oe,{modelValue:e(a).type,"onUpdate:modelValue":u[3]||(u[3]=i=>e(a).type=i),label:e(c).GENERAL.LABEL.type,options:b.value,disable:H.value||e(U),"popup-content-class":"b-select-popup",class:"b-field","data-testid":"type-select","emit-value":"","map-options":""},null,8,["modelValue","label","options","disable"]),m(oe,{ref_key:"$versionSelect",ref:S,modelValue:e(a).version,"onUpdate:modelValue":u[4]||(u[4]=i=>e(a).version=i),options:Z.value,label:e(c).CONFIGURATION.DEVICES.LABEL.version+" *",onBlur:Se,onFilter:ee,hint:e(r)("error.rangeWithStep",{min:T.value/Te,max:lt/Te,step:1/Te}),"hide-selected":"",class:"b-field","data-testid":"version-select","popup-content-class":"b-select-popup","input-debounce":"0","use-input":"","fill-input":"","emit-value":"","map-options":""},null,8,["modelValue","options","label","hint"]),m(se,{modelValue:e(a).address,"onUpdate:modelValue":u[5]||(u[5]=i=>e(a).address=i),modelModifiers:{number:!0},"data-testid":"address-input",min:5,max:126,label:e(c).GENERAL.LABEL.address+" *",disable:H.value,class:"b-field",type:"number",hint:Ve.value,rules:[i=>e(Ie).coerce.number().integer().min(5,{validateIf:!H.value}).max(126).notIn(ve.value).required().validate(i)]},null,8,["modelValue","label","disable","hint","rules"]),m(Re,{modelValue:e(a).zone_index,"onUpdate:modelValue":u[6]||(u[6]=i=>e(a).zone_index=i),label:e(c).GENERAL.LABEL.zone,disable:H.value||e(U),"include-zones-pt":e(U),"popup-content-class":"b-select-popup",class:"b-field","exclude-alien-zones":""},null,8,["modelValue","label","disable","include-zones-pt"]),m(se,{modelValue:e(a).contact_id,"onUpdate:modelValue":u[7]||(u[7]=i=>e(a).contact_id=i),modelModifiers:{number:!0},min:1,max:999,hint:e(r)("error.range",{min:1,max:999}),rules:[i=>e(Ie).coerce.number().integer().min(1).max(999).validate(i)],type:"number",label:"Contact ID","data-testid":"contact-id-input",class:"b-field"},null,8,["modelValue","hint","rules"]),m(Ut,{modelValue:e(a).single_interface,"onUpdate:modelValue":u[8]||(u[8]=i=>e(a).single_interface=i),label:e(c).CONFIGURATION.DEVICES.LABEL.single_interface,disable:H.value,"data-testid":"single-interface-checkbox",class:"b-checkbox","left-label":""},null,8,["modelValue","label","disable"])]),_:1},8,["label"]),p.value?(y(),I(ue,{key:0,label:e(c).CONFIGURATION.DEVICES.translateSettings},{default:K(()=>[m(e(fe),{modelValue:e(a).translate_mask,"onUpdate:modelValue":u[9]||(u[9]=i=>e(a).translate_mask=i),label:e(c).CONFIGURATION.DEVICES.LABEL.translate_mask,items:e(n),"data-key":"index",type:"translate_mask","data-testid":"translate-mask-dnd"},null,8,["modelValue","label","items"]),m(e(fe),{modelValue:e(a).translate_zones,"onUpdate:modelValue":u[10]||(u[10]=i=>e(a).translate_zones=i),label:e(c).CONFIGURATION.DEVICES.LABEL.translate_zones,items:e(n),type:"zone","data-testid":"translate-zones-dnd","data-key":"index",itemMarker:"extendedMarker"},null,8,["modelValue","label","items"]),m(e(fe),{modelValue:e(a).translate_zonegroups,"onUpdate:modelValue":u[11]||(u[11]=i=>e(a).translate_zonegroups=i),label:e(c).CONFIGURATION.DEVICES.LABEL.translate_zonegroups,items:e(n),type:"zone_group","data-testid":"translate-zonegroups-dnd","data-key":"index",itemMarker:"extendedMarker"},null,8,["modelValue","label","items"]),m(oe,{modelValue:e(a).translate_format,"onUpdate:modelValue":u[12]||(u[12]=i=>e(a).translate_format=i),label:e(c).CONFIGURATION.DEVICES.LABEL.translate_format,options:N.value,class:"b-field","emit-value":"","map-options":"","data-testid":"translate-format-select"},null,8,["modelValue","label","options"])]),_:1},8,["label"])):R("",!0)]),te("div",Kt,[e(_)?R("",!0):(y(),I(h,{key:0,label:e(c).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),!H.value&&!e(_)||C.value?(y(),I(h,{key:1,ref_key:"deleteButtonRef",ref:w,label:le.value,loading:e(F),disable:e(P),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(B)},null,8,["label","loading","disable","onClick"])):R("",!0),m(h,{loading:e(P),label:Ue.value,disable:e(F),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["loading","label","disable"])])]),_:1},8,["onSubmit","onReset"]))}},Qt={class:"config-form__body"},Xt={class:"config-form__buttons"},Yt={__name:"AppBaseForm",props:{elements:{type:Array,default:()=>[]}},emits:["update:elements"],setup(z,{emit:$}){const c=ce(),r=z,f=$,{form:g,formRef:S,deleteButtonRef:a,mainFormElement:k,isSaving:w,onSave:P,isDeleting:O,onDelete:F,saveButtonLabel:B,onReset:_,deleteButtonLabel:L}=ge({props:r,saveFn:U,deleteFn:M,resetFn:j}),{isAttachedZonePt:l}=xe(k),{confirmElementsDeletion:J}=Le(),q=pe();function j({form:x}){x.value=we(r.elements)}async function U(){const x=r.elements.map(n=>me({...n,...g.value}));return w.value=!0,await q.dispatch("config/saveElement",{elementList:x.map(n=>({data:n,type:n.elementType}))}),f("update:elements",x),!0}async function M(){const x=[...r.elements],n=await J(x);if(n)return O.value=!0,await q.dispatch("config/deleteElement",{elementList:n.map(b=>({index:b.index,type:b.elementType})),stash:!0}),await q.dispatch("config/integrityCheck"),!0}const W=o(()=>r.elements.some(x=>x.elementType==="reader"));return(x,n)=>(y(),I(Oe,{class:"config-form",ref_key:"formRef",ref:S,onSubmit:e(P),onReset:e(_)},{default:K(()=>[te("div",Qt,[m(Ee,{elements:z.elements,"onUpdate:elements":n[0]||(n[0]=b=>f("update:elements",b)),"multiple-editing":""},null,8,["elements"]),m(se,{modelValue:e(g).name,"onUpdate:modelValue":n[1]||(n[1]=b=>e(g).name=b),modelModifiers:{trim:!0},"data-testid":"name-input",label:e(c).GENERAL.LABEL.name,rules:e(Ae),maxlength:"31",class:"b-field"},null,8,["modelValue","label","rules"]),W.value?R("",!0):(y(),I(Re,{key:0,modelValue:e(g).zone_index,"onUpdate:modelValue":n[2]||(n[2]=b=>e(g).zone_index=b),label:e(c).GENERAL.LABEL.zone,"include-zones-pt":e(l),disable:e(l),"popup-content-class":"b-select-popup",class:"b-field","exclude-alien-zones":""},null,8,["modelValue","label","include-zones-pt","disable"]))]),te("div",Xt,[m(h,{label:e(c).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"]),m(h,{ref_key:"deleteButtonRef",ref:a,label:e(L),loading:e(O),disable:e(w),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(F)},null,8,["label","loading","disable","onClick"]),m(h,{loading:e(w),label:e(B),disable:e(O),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["loading","label","disable"])])]),_:1},8,["onSubmit","onReset"]))}},Ht={key:0,class:"config-form"},Jt={class:"config-form__body"},Wt={class:"column gap-16"},el={class:"row no-wrap gap-16"},tl={key:0,class:"row no-wrap gap-16"},ll={__name:"AppDeviceElementsCreator",props:{elements:{type:Array,default:()=>[]}},emits:["update:elements"],setup(z,{emit:$}){const{maxElementsToast:c}=dt(),r=ce(),f=Me("$toast"),g=z,S=$,a=JSON.parse(JSON.stringify(g.elements)),k=ae(a),{isMultipleEditing:w}=ge({props:g}),P=o(()=>k.value[0]),O=pe(),F=o(()=>O.getters["device/DEVICE_LIST"]),B=o(()=>O.getters["input/inputArray"]),_=o(()=>O.getters["output/outputArray"]),L=o(()=>O.getters["device/DEVICE_TREE"]);function l(){q(Ye.elements,r.value.CONFIGURATION.DEVICES[Ye.name],r.value.CONFIGURATION.DEVICES.BUTTON.addSP4)}function J(){q(He.elements,r.value.CONFIGURATION.DEVICES[He.name],r.value.CONFIGURATION.DEVICES.BUTTON.addPKR)}function q(n,b){const N=()=>{const Z=n.filter(Q=>Q.elementType==="input").length;if(B.value.length>Je-Z)return c(Je),!1;const ee=n.filter(Q=>Q.elementType==="output").length;return _.value.length>We-ee?(c(We),!1):!0},V=()=>{const Z=F.value[P.value.device_index].address,X=L.value.find(p=>p.data.address===Z).children.find(p=>p.id.includes("addressDevice")).children,Y=X.findIndex(p=>p.id===P.value.uniqueIndex);return X.slice(Y,Y+n.length).filter(p=>p.local).map(p=>p.data.number)},T=(Z,ee,Q)=>Z.map((X,Y)=>({...Ge(P.value.device_index,X.elementType,Q[Y],ee[Y]),...X}));if(!N())return;const G=V();G.length===n.length?(k.value=T(n,b,G),U.value="form"):f.add({summary:r.value.CONFIGURATION.GENERAL.DAMPER_DELETE_MODAL.error,detail:`${r.value.CONFIGURATION.GENERAL.required}: ${n.length}`,type:"warning"})}function j(n){k.value=k.value.map(b=>Ge(b.device_index,n,b.number)),U.value="form"}const U=ae("selector"),M=o(()=>{switch(P.value.elementType){case"input":return ct;default:return pt}});function W(){k.value=a,U.value="selector"}function x(n){if(n.every(N=>Number.isInteger(N.index)))S("update:elements",n);else{const N=n.map(G=>G.number),V=a.filter(G=>N.includes(G.number)),T=k.value.filter(G=>N.includes(G.number));k.value=T,S("update:elements",V)}}return(n,b)=>(y(),I(rt,{name:"fade",mode:"out-in"},{default:K(()=>[U.value==="selector"?(y(),re("div",Ht,[te("div",Jt,[m(Ee,{title:e(r).CONFIGURATION.DEVICES.newAddressDevice,"onUpdate:elements":b[0]||(b[0]=N=>S("update:elements",N))},null,8,["title"]),te("div",Wt,[te("div",el,[m(h,{class:"w-full",label:e(r).GENERAL.LABEL.input,color:"back","text-color":"primary",onClick:b[1]||(b[1]=N=>j("input")),"data-testid":"add-input-btn"},null,8,["label"]),m(h,{class:"w-full",label:e(r).GENERAL.LABEL.output,color:"back","text-color":"primary",onClick:b[2]||(b[2]=N=>j("output")),"data-testid":"add-output-btn"},null,8,["label"])]),e(w)?R("",!0):(y(),re("div",tl,[m(h,{class:"w-full",label:e(r).CONFIGURATION.DEVICES.DAMPERS.SP4,color:"back","text-color":"primary",onClick:l,"data-testid":"add-sp4-btn"},null,8,["label"]),m(h,{class:"w-full",label:e(r).CONFIGURATION.DEVICES.DAMPERS.PKR,color:"back","text-color":"primary",onClick:J,"data-testid":"add-pkr-btn"},null,8,["label"])]))])])])):U.value==="form"?(y(),I(ut(M.value),{key:1,elements:k.value,"onUpdate:elements":x,onClose:W,closable:""},null,40,["elements"])):R("",!0)]),_:1}))}},al=1e3,bl={__name:"AppDevicesPage",setup(z){const{maxElementsToast:$}=dt(),c=ce(),r=pe(),f=o(()=>r.getters["device/DEVICE_TREE"]),g=o(()=>({zone:_.value?r.getters["zone/ZONE_TREE"].filter(n=>n.data.controller_index===0):r.getters["zone/ZONE_TREE"],zone_group:_.value?r.getters["zone_group/ZONE_GROUP_TREE"].filter(n=>n.data.controller_index===0):r.getters["zone_group/ZONE_GROUP_TREE"],translate_mask:r.getters["device/TRANSLATE_CLASSES_TREE"]})),{formId:S,leftTreeRef:a,mainFormElementType:k,selectedElements:w,selectedTreeItemIds:P,selectNewTreeItemIds:O,updateSelectedElements:F,onAdd:B}=Dt({leftTree:f,rightTree:g,add:M}),_=o(()=>k.value==="device"),L=o(()=>{const n=[{name:"zone",label:_.value?c.value.GENERAL.LABEL.translate_zones:c.value.GENERAL.LABEL.zones},{name:"zone_group",label:_.value?c.value.GENERAL.LABEL.translate_zoneGroups:c.value.GENERAL.LABEL.zoneGroups}];return _.value&&n.push({name:"translate_mask",label:c.value.CONFIGURATION.DEVICES.LABEL.translate_mask}),n}),l=ae();it(()=>{l.value=L.value[0].name});const J=o(()=>{const n=w.value.slice(1).map(V=>V.elementType),b=n.some(V=>V!==k.value),N=n.every(V=>V==="device");if(n.length&&(b||N))return Yt;switch(k.value){case"input":return ct;case"output":return pt;case"channel":return Gt;case"reader":return Ft;case"addressDevice":return ll;default:return Zt}}),q=ae(!1);Vt(()=>{q.value=!0});async function j(){q.value||(await r.dispatch("device/fetchAndSetConnectedLocalDeviceData"),setTimeout(j,al))}const U=o(()=>r.getters["device/deviceArray"]);function M(){if(U.value.length>=ke){$(ke);return}const n=St(U.value.map(N=>N.address),ke+1,5);return kt({...Bt("device"),address:n,index:null,type:85,version:100})}function W(n,b){const N=w.value.map(T=>({...Ge(T.device_index,b,T.number,T.name),index:T.index,uniqueIndex:T.uniqueIndex}));["contact_id","zone_index"].forEach(T=>{Object.hasOwn(n,T)&&N.forEach(G=>{G[T]=n[T]})}),w.value=N}j();const x=ae([]);return(n,b)=>(y(),re(Fe,null,[m(e(et),{ref_key:"leftTreeRef",ref:a,selected:e(P),"onUpdate:selected":e(O),onAdd:e(B),items:f.value,title:e(c).ROUTER.CONFIG.devices,"can-multiple-selection":"","required-selection":"",searchable:"","add-button":""},null,8,["selected","onUpdate:selected","onAdd","items","title"]),e(w).length?(y(),I(rt,{key:0,name:"fade",mode:"out-in"},{default:K(()=>[(y(),re("div",{class:"config-form-wrapper",key:e(S)},[(y(),I(ut(J.value),{elements:e(w),"onUpdate:elements":e(F),onReplace:W},null,40,["elements","onUpdate:elements"]))]))]),_:1})):R("",!0),m(e(et),{tab:l.value,"onUpdate:tab":b[0]||(b[0]=N=>l.value=N),selected:x.value,"onUpdate:selected":b[1]||(b[1]=N=>x.value=N),items:g.value[l.value],tabs:L.value,"is-right-tree":"","can-multiple-selection":"","can-selection-all-children":"",searchable:""},null,8,["tab","selected","items","tabs"])],64))}};export{bl as default};
