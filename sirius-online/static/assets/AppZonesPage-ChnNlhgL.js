import{a as le,u as _e,b as oe,c as i,i as Ne,aj as ye,H as Re,ak as Ce,d as K,M as Y,O as j,al as Oe,am as Ae,o as p,e as I,w as X,f as ee,g as m,h as e,j as q,k as he,v as te,Q as Ze,m as _,l as P,F as se,a3 as De,n as Q,p as ke,q as Le,r as ne,s as Ue,T as ze,C as Ve,an as Se,A as we}from"./app-X261GMLD.js";import{_ as Fe,A as Be,a as ae}from"./AppConfigFormHeader-CpKOoRvu.js";import{u as Ge}from"./useConfigDialog-CoOncFYH.js";import{g as Me}from"./getUpdatedElement-DO3HsR5I.js";import{c as je}from"./compareConfigElements-CU2Ub2iG.js";import{A as qe}from"./AppDragAndDropArea-Cr3Xjs1I.js";import{u as Qe,a as Xe}from"./useConfigForm-Dwead9lM.js";import{u as re}from"./useConfigZone-Bz7OuTNL.js";const Pe={class:"config-form__body"},We={class:"config-form__buttons"},$e={__name:"AppZoneForm",props:{elements:{type:Array,default:()=>[]}},emits:["update:elements"],setup(h,{emit:v}){const{confirmEmptyElementDeletion:d,showDeleteDialog:L,confirmEmptyZoneGroupDeletion:U,showOkDialog:N,showDescribedDialog:y}=Ge(),u=le(),{t:R}=_e(),r=oe(),z=i(()=>r.getters["zone/ZONE_LIST"]),V=i(()=>r.getters["output/outputArray"]),Z=i(()=>r.getters["reader/readerArray"]),S=i(()=>r.getters["controller/controllerArray"]),w=i(()=>r.getters["zone_group/zoneGroupIndexesIncludedZoneIndex"]),F=i(()=>r.getters["zone/fireZonesByIndex"]),C=h,O=v,E=Ne("rightTree"),T=i(()=>Array.from(ye(Object.values(E.value).flat()).values()).filter(a=>{var n;return!a.passive&&!a.isNonDraggable||((n=a.data)==null?void 0:n.zone_index)===C.elements[0].index}).map(a=>{var n;return{...a,nonDeletable:Re(a.data)&&((n=a.data)==null?void 0:n.device_index)!==Ce}}));function D(a){return a.filter(n=>n.data.zone_index===C.elements[0].index)}const f=i(()=>D(T.value).map(a=>a.id)),{form:t,formRef:b,deleteButtonRef:ie,isSaving:B,onSave:de,isDeleting:G,onDelete:ue,isNew:$,mainFormElement:H,deleteButtonLabel:me,saveButtonLabel:ce,onReset:pe}=Qe({props:C,saveFn:Ee,deleteFn:Te,resetFn:ve}),{nonUniqueZoneContactIds:fe,nonUniqueZoneNumbers:be,freeZoneIndex:ge}=re(t);function ve({form:a,mainFormElement:n}){a.value={...K(n.value),zoneComposition:K(f.value)}}async function Ee(){const a=Me(t.value),n=a.controller_index!==Y;B.value=!0;const l=[a,...M(),...k()];function x(s,g){const c=[];return c.push({...s,zone_index:g}),s.isMainDamperElement&&c.push(...r.getters["output/getRelatedDamperElements"](s).filter(o=>o.zone_index===s.zone_index&&o.zone_index!==j).map(o=>({...o,zone_index:g}))),c}function M(){return f.value.filter(s=>!t.value.zoneComposition.includes(s)).reduce((s,g)=>{const c=T.value.find(o=>o.id===g).data;return s.push(...x(c,j)),s},[])}function k(){return t.value.zoneComposition.reduce((s,g)=>{const c=T.value.find(Ie=>Ie.id===g).data,o=n?j:a.index??ge.value;return s.push(...x(c,o)),s},[])}return await r.dispatch("config/saveElement",{elementList:l.map(s=>({data:s,type:s.elementType}))}),O("update:elements",[a]),!0}async function Te(){const a=t.value.index,{TITLE:n,TITLE_ERROR:l,ERROR:x}=u.value.CONFIGURATION.ZONES.DELETE_DIALOG,M=Oe(F.value,o=>o.has(a)&&o.size===1),k=Object.keys(M).map(o=>z.value[o]);if(k.length>0)return await y(N,l,x,k),!1;if(!await L(n))return;G.value=!0;const s=w.value[a]||[],g=V.value.filter(o=>o.related_zonegroups.includes(a)).map(o=>o.index),c=Z.value.filter(o=>o.allowed_zonegroups.includes(a)).map(o=>o.index);return await r.dispatch("config/deleteElement",{index:a,type:"zone",stash:!0}),await r.dispatch("config/integrityCheck"),await U(s),await d(g,c,"zone"),await r.dispatch("config/integrityCheck"),!0}const J=i(()=>r.getters["controller/masterControllerIsStandalone"]),xe=i(()=>t.value.controller_index==Y),A=i(()=>t.value.index===Ae);return(a,n)=>(p(),I(ke,{class:"config-form",ref_key:"formRef",ref:b,onSubmit:e(de),onReset:e(pe)},{default:X(()=>[ee("div",Pe,[m(Fe,{title:e(H).filledName,marker:e(H).number,"onUpdate:elements":n[0]||(n[0]=l=>O("update:elements",l))},null,8,["title","marker"]),m(Be,{label:e(u).CONFIGURATION.DEVICES.mainSettings},{default:X(()=>[m(q,{modelValue:e(t).name,"onUpdate:modelValue":n[1]||(n[1]=l=>e(t).name=l),modelModifiers:{trim:!0},"data-testid":"name-input",label:e(u).GENERAL.LABEL.name,rules:e(he),disable:A.value,maxlength:"31",class:"b-field"},null,8,["modelValue","label","rules","disable"]),m(q,{modelValue:e(t).number,"onUpdate:modelValue":n[2]||(n[2]=l=>e(t).number=l),modelModifiers:{number:!0},min:1,max:65535,label:e(u).GENERAL.LABEL.number+" *",class:"b-field",type:"number",hint:e(R)("error.range",{min:1,max:65535}),rules:[l=>e(te).coerce.number().integer().min(1).max(65535).notIn(e(be)).required().validate(l)],disable:A.value,"data-testid":"number-input"},null,8,["modelValue","label","hint","rules","disable"]),m(q,{modelValue:e(t).contact_id,"onUpdate:modelValue":n[3]||(n[3]=l=>e(t).contact_id=l),modelModifiers:{number:!0},min:1,max:99,hint:e(R)("error.range",{min:1,max:99}),rules:[l=>e(te).coerce.number().integer().min(1).max(99).notIn(e(fe)).validate(l)],type:"number",label:"Contact ID","data-testid":"contact-id-input",class:"b-field"},null,8,["modelValue","hint","rules"]),J.value?_("",!0):(p(),I(Ze,{key:0,modelValue:e(t).controller_index,"onUpdate:modelValue":n[4]||(n[4]=l=>e(t).controller_index=l),options:S.value,disable:A.value,label:e(u).CONFIGURATION.ZONES.LABEL.controller_index+" *","popup-content-class":"b-select-popup",class:"b-field","emit-value":"","map-options":"","option-value":"index","option-label":"formattedName","data-testid":"controller-index-select"},null,8,["modelValue","options","disable","label"])),xe.value?(p(),P(se,{key:1},[J.value?_("",!0):(p(),I(De,{key:0,modelValue:e(t).is_interpanel,"onUpdate:modelValue":n[5]||(n[5]=l=>e(t).is_interpanel=l),label:e(u).CONFIGURATION.ZONE_GROUPS.LABEL.is_interpanel,disable:A.value,"data-testid":"is-interpanel-checkbox",class:"b-checkbox","left-label":""},null,8,["modelValue","label","disable"])),m(e(qe),{modelValue:e(t).zoneComposition,"onUpdate:modelValue":n[6]||(n[6]=l=>e(t).zoneComposition=l),label:e(u).CONFIGURATION.ZONES.ZONE_TABLE.COUNTER,items:T.value,type:["device","output","channel","input","controller","addressDevice"],"compare-items":(l,x)=>e(je)(l.data,x.data),"data-key":"uniqueIndex","item-type":"type","item-label":"extendedLabel","item-tags":"extendedTags",itemMarker:"extendedMarker","data-testid":"included-zones-dnd"},null,8,["modelValue","label","items","compare-items"])],64)):_("",!0)]),_:1},8,["label"])]),ee("div",We,[e($)?_("",!0):(p(),I(Q,{key:0,label:e(u).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),!e($)&&!A.value?(p(),I(Q,{key:1,ref_key:"deleteButtonRef",ref:ie,label:e(me),loading:e(G),disable:e(B),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(ue)},null,8,["label","loading","disable","onClick"])):_("",!0),m(Q,{loading:e(B),label:e(ce),disable:e(G),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["loading","label","disable"])])]),_:1},8,["onSubmit","onReset"]))}},W=(h,v)=>[...h.filter(d=>v(d)).map(d=>d.children?{...d,children:d.children.length>0?W(d.children,v):void 0}:d)],lt={__name:"AppZonesPage",setup(h){const{freeZoneNumber:v,MAX_COUNT_ZONES:d,zoneArray:L}=re(),{maxElementsToast:U}=Xe(),N=le(),y=oe(),u=i(()=>W(y.getters["zone/ZONE_TREE"],f=>!f.data.isZonePt)),R=f=>W(f,t=>{var b;return!t.local&&t.type!=="reader"&&(Number.isInteger((b=t.data)==null?void 0:b.index)||t.passive)&&!Ve(t.data)}),r=i(()=>({device:R(y.getters["device/DEVICE_TREE"]),controller:R(y.getters["controller/CONTROLLER_TREE"])})),{formId:z,leftTreeRef:V,selectedElements:Z,selectedTreeItemIds:S,selectNewTreeItemIds:w,updateSelectedElements:F,onAdd:C}=Le({leftTree:u,rightTree:r,add:T}),O=i(()=>[{name:"device",label:N.value.ROUTER.CONFIG.devices},{name:"controller",label:N.value.ROUTER.CONFIG.controllers}]),E=ne();Ue(()=>{E.value=O.value[0].name});function T(){if(L.value.length>=d){U(d);return}return Se({...we("zone"),number:v.value,index:null})}const D=ne([]);return(f,t)=>(p(),P(se,null,[m(e(ae),{ref_key:"leftTreeRef",ref:V,selected:e(S),"onUpdate:selected":e(w),onAdd:e(C),items:u.value,title:e(N).ROUTER.CONFIG.zones,"add-button":"","required-selection":"",searchable:""},null,8,["selected","onUpdate:selected","onAdd","items","title"]),e(Z).length?(p(),I(ze,{key:0,name:"fade",mode:"out-in"},{default:X(()=>[(p(),P("div",{class:"config-form-wrapper",key:e(z)},[m($e,{elements:e(Z),"onUpdate:elements":e(F)},null,8,["elements","onUpdate:elements"])]))]),_:1})):_("",!0),m(e(ae),{tab:E.value,"onUpdate:tab":t[0]||(t[0]=b=>E.value=b),items:r.value[E.value],selected:D.value,"onUpdate:selected":t[1]||(t[1]=b=>D.value=b),tabs:O.value,"is-right-tree":"","can-multiple-selection":"",searchable:""},null,8,["tab","items","selected","tabs"])],64))}};export{lt as default};
