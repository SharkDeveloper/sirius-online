import{a as J,c as p,aJ as Q,o as f,e as g,aK as te,aL as ue,d as j,av as Ae,i as Oe,aM as ge,aN as W,ae as Re,aO as ye,P as ee,aP as le,R as Ne,aQ as Ie,aR as Ce,aS as re,w as T,f as H,g as c,ag as ae,Q as K,h as e,m as V,a3 as z,Y as Te,Z as oe,l as X,n as L,p as me,u as _e,b as ce,aT as Ee,aU as Se,r as w,j as ne,aV as Ve,af as Ge,U as Y,aW as D,v as Ue,T as pe,q as Pe,y as Me,aX as se,F as ke,aY as ie,A as Fe}from"./app-X261GMLD.js";import{_ as fe,A as be,a as de}from"./AppConfigFormHeader-CpKOoRvu.js";import{b as Le,u as xe,g as he,a as we}from"./useConfigForm-Dwead9lM.js";import{u as De}from"./useConfigDialog-CoOncFYH.js";import{g as Be}from"./getUpdatedElement-DO3HsR5I.js";import{A as ve}from"./AppDragAndDropArea-Cr3Xjs1I.js";import{_ as $e}from"./AppInputNumber-pcfWNGSA.js";import{A as qe,_ as Qe,a as je}from"./AppStateSelect-DHjP7sCy.js";import{r as We}from"./range-_Bp7Yin7.js";const He={__name:"AppProgramConditions",props:{label:{type:String,default:""},modelValue:{type:Array,default:()=>[]},hint:{type:String,default:""},readonly:{type:Boolean,default:!1},required:{type:[Boolean,Object],default:!1},rules:{type:Array,default:()=>[]}},emits:["add","update:modelValue","editCondition"],setup(n,{emit:N}){const u=J(),b=n,d=N,R=p({get:()=>{const s=[];return b.modelValue.forEach((l,v)=>{Q(l)||s.push(v)}),s},set:s=>{const l=[];for(b.modelValue.forEach((v,G)=>{s.includes(G)&&l.push(v)});l.length!==te;)l.push(ue());d("update:modelValue",l)}}),I=p(()=>b.modelValue.map((s,l)=>({id:l,type:"condition",label:`${u.value.CONFIGURATION.PROGRAMS.condition} ${l+1}`,isNew:s.isNew,editable:!0,copyable:!b.readonly&&!C.value,nonDeletable:b.readonly,data:{index:l}}))),C=p(()=>b.modelValue.filter(s=>Q(s)).length===0);function a(s){d("editCondition",s)}function r(s){const l=[...b.modelValue],v=j(l[s]);v.isNew=!0;const G=l.findIndex(_=>Q(_));l[G]=v,d("update:modelValue",l)}return(s,l)=>(f(),g(ve,{modelValue:R.value,"onUpdate:modelValue":l[0]||(l[0]=v=>R.value=v),label:n.label,"add-button":!n.readonly&&!C.value,"edit-button":!1,"clear-button":!n.readonly,hint:n.hint,items:I.value,required:n.required,rules:n.rules,onAdd:l[1]||(l[1]=v=>d("add")),onEditItem:a,onCopyItem:r,type:"condition","close-button":""},null,8,["modelValue","label","add-button","clear-button","hint","items","required","rules"]))}},Ke={class:"config-form__body"},Ye={class:"parent-program-label text-base"},Xe={key:0,class:"config-form__buttons"},Je={__name:"AppProgramConditionForm",props:{modelValue:{type:Object,required:!0},title:{type:String,default:""},readonly:{type:Boolean,default:!1},program:{type:Object,required:!0}},emits:["update:modelValue","close"],setup(n,{emit:N}){const u=J(),b=n,d=N,R=Oe("rightTree"),I=p(()=>Q(b.modelValue)),C=p({get(){return a.value.activate_time!==ge},set(t){a.value.activate_time=+t}}),{form:a,formRef:r,onSave:s,onReset:l}=Le({saveFn:G,resetFn:v,isCheckDirtyForm:!1});function v({form:t}){t.value=j(b.modelValue),I.value&&(t.value.command=W,t.value.switch_mask=W)}async function G(){const t=j(a.value);Re(t,b.modelValue)||(t.isNew=!0,d("update:modelValue",t)),d("close")}const _=p(()=>ye.includes(a.value.command));ee(_,t=>{t?a.value.switch_mask===W&&(a.value.switch_mask=le[0].value):a.value.switch_mask=W},{immediate:!0});const x=p(()=>Ne.includes(a.value.command));ee(x,t=>{t||(C.value=!1)},{immediate:!0});const k=p(()=>Ie.map(t=>({value:t,label:u.value.CONFIGURATION.PROGRAMS.COMMAND_OPTIONS[t]}))),P=p(()=>Ce.map(t=>({value:t,label:u.value.CONFIGURATION.PROGRAMS.DELAY_OPTIONS[t]})));function B(t){a.value.is_active=t,t||(a.value.is_manual_start=!1)}function $(){d("close")}const q=p(()=>re.map(t=>({label:u.value.CONFIGURATION.PROGRAMS.STATES_GROUPS_OPTIONS[t],value:t})));return(t,m)=>(f(),g(me,{class:"config-form",ref_key:"formRef",ref:r,onSubmit:e(s),onReset:e(l)},{default:T(()=>[H("div",Ke,[c(fe,{title:n.title,onClose:$,closable:"","disable-prevent-close-form":""},{default:T(()=>[H("span",Ye,ae(n.program.formattedName),1)]),_:1},8,["title"]),c(be,null,{default:T(()=>[c(K,{modelValue:e(a).command,"onUpdate:modelValue":m[0]||(m[0]=o=>e(a).command=o),options:k.value,label:e(u).CONFIGURATION.PROGRAMS.LABEL.command,disable:n.readonly,"emit-value":"","map-options":"","popup-content-class":"b-select-popup",class:"b-field","data-testid":"command-select"},null,8,["modelValue","options","label","disable"]),_.value?(f(),g(K,{key:0,modelValue:e(a).switch_mask,"onUpdate:modelValue":m[1]||(m[1]=o=>e(a).switch_mask=o),options:e(le),label:e(u).CONFIGURATION.PROGRAMS.LABEL.switch_mask,disable:n.readonly,"emit-value":"","map-options":"","popup-content-class":"b-select-popup",class:"b-field","data-testid":"switch-mask-select"},null,8,["modelValue","options","label","disable"])):V("",!0),c(K,{modelValue:e(a).delay,"onUpdate:modelValue":m[2]||(m[2]=o=>e(a).delay=o),options:P.value,label:e(u).CONFIGURATION.PROGRAMS.LABEL.delay,disable:n.readonly,"emit-value":"","map-options":"","popup-content-class":"b-select-popup",class:"b-field","data-testid":"delay-select"},null,8,["modelValue","options","label","disable"]),H("div",null,[x.value?(f(),g(z,{key:0,modelValue:C.value,"onUpdate:modelValue":m[3]||(m[3]=o=>C.value=o),label:e(u).CONFIGURATION.PROGRAMS.LABEL.redefine_activate_time,disable:n.readonly,"data-testid":"redefine-active-time-checkbox",class:"b-checkbox","left-label":""},null,8,["modelValue","label","disable"])):V("",!0),C.value?(f(),g($e,{key:1,modelValue:e(a).activate_time,"onUpdate:modelValue":m[4]||(m[4]=o=>e(a).activate_time=o),disable:n.readonly,min:1,max:e(Te),step:e(oe),multiple:e(oe),label:e(u).CONFIGURATION.OUTPUTS.LABEL.activate_time,"data-testid":"activate-time-input",required:""},null,8,["modelValue","disable","max","step","multiple","label"])):V("",!0),c(z,{"model-value":e(a).is_active,"onUpdate:modelValue":B,label:e(u).CONFIGURATION.PROGRAMS.LABEL.is_active,disable:n.readonly,"data-testid":"is-active-checkbox",class:"b-checkbox","left-label":""},null,8,["model-value","label","disable"]),c(z,{modelValue:e(a).is_manual_start,"onUpdate:modelValue":m[5]||(m[5]=o=>e(a).is_manual_start=o),label:e(u).CONFIGURATION.PROGRAMS.LABEL.is_manual_start,disable:n.readonly||!e(a).is_active,"data-testid":"is-manual-start-checkbox",class:"b-checkbox","left-label":""},null,8,["modelValue","label","disable"])]),c(ve,{modelValue:e(a).state_mask,"onUpdate:modelValue":m[6]||(m[6]=o=>e(a).state_mask=o),label:e(u).CONFIGURATION.SCRIPTS.LABEL.allowed_states,items:e(R),disable:n.readonly,"modal-group-options":q.value,required:"","data-key":"index",type:"state","data-testid":"state-mask-dnd"},null,8,["modelValue","label","items","disable","modal-group-options"])]),_:1})]),n.readonly?V("",!0):(f(),X("div",Xe,[I.value?V("",!0):(f(),g(L,{key:0,label:e(u).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),c(L,{label:I.value?e(u).CONFIGURATION.PROGRAMS.BUTTON.addCondition:e(u).GENERAL.BUTTON.apply,class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["label"])]))]),_:1},8,["onSubmit","onReset"]))}},Ze=Ae(Je,[["__scopeId","data-v-cae4a95c"]]),ze={class:"config-form__body"},ea={key:0,class:"config-form__buttons"},aa={__name:"AppProgramForm",props:{elements:{type:Array,default:()=>[]}},emits:["update:elements"],setup(n,{emit:N}){const{showDeleteDialog:u}=De(),{t:b}=_e(),d=J(),R=ce(),I=p(()=>R.getters["program/programArray"]),C=n,a=N,{form:r,formRef:s,deleteButtonRef:l,isSaving:v,onSave:G,isDeleting:_,onDelete:x,isNew:k,mainFormElement:P,deleteButtonLabel:B,saveButtonLabel:$,onReset:q}=xe({props:C,saveFn:m,deleteFn:o,resetFn:t});function t({form:A,mainFormElement:O}){A.value=j(O.value)}async function m(){const A=Be(r.value);return A.conditions.forEach(O=>delete O.isNew),v.value=!0,await R.dispatch("config/saveElement",{data:A,type:A.elementType}),a("update:elements",[A]),!0}async function o(){const A=r.value.index;if(await u(d.value.CONFIGURATION.PROGRAMS.DELETE_DIALOG.title))return _.value=!0,await R.dispatch("config/deleteElement",{index:A,type:"program",stash:!0}),await R.dispatch("config/integrityCheck"),!0}const M=p(()=>he(I.value,"number",r.value.index)),h=p(()=>Ee.map(A=>({value:A,label:d.value.CONFIGURATION.PROGRAMS.DEFAULT_COMMAND_OPTIONS[A]}))),E=p(()=>Se(P.value)),F=w("program"),i=w(null);function S(A){F.value="condition",i.value=A}function U(){F.value="condition";const A=r.value.conditions.findIndex(Q);i.value=A}function Z(){F.value="program",i.value=null}return(A,O)=>(f(),g(pe,{name:"fade",mode:"out-in"},{default:T(()=>[F.value==="program"?(f(),g(me,{key:0,class:"config-form",ref_key:"formRef",ref:s,onSubmit:e(G),onReset:e(q)},{default:T(()=>[H("div",ze,[c(fe,{title:e(P).filledName,marker:e(P).number,"onUpdate:elements":O[0]||(O[0]=y=>a("update:elements",y))},null,8,["title","marker"]),c(be,{label:e(d).CONFIGURATION.DEVICES.mainSettings},{default:T(()=>[c(ne,{modelValue:e(r).name,"onUpdate:modelValue":O[1]||(O[1]=y=>e(r).name=y),modelModifiers:{trim:!0},label:e(d).GENERAL.LABEL.name,rules:e(Ve),disable:E.value,"data-testid":"name-input",maxlength:"63",class:"b-field"},null,8,["modelValue","label","rules","disable"]),c(ne,Ge({modelValue:e(r).number,"onUpdate:modelValue":O[2]||(O[2]=y=>e(r).number=y),modelModifiers:{number:!0},min:e(Y)+1,max:e(D),hint:E.value?void 0:e(b)("error.range",{min:e(Y)+1,max:e(D)}),disable:E.value,label:e(d).GENERAL.LABEL.number+" *",rules:[y=>e(Ue).coerce.number().integer().required().notIn(M.value).min(e(Y)+1).max(e(D)).validate(y)]},E.value,{type:"number","data-testid":"number-input",class:"b-field"}),null,16,["modelValue","min","max","hint","disable","label","rules"]),c(K,{modelValue:e(r).default_command,"onUpdate:modelValue":O[3]||(O[3]=y=>e(r).default_command=y),options:h.value,label:e(d).CONFIGURATION.PROGRAMS.LABEL.defaultCommand,disable:E.value,"emit-value":"","map-options":"","popup-content-class":"b-select-popup",class:"b-field","data-testid":"default-command-select"},null,8,["modelValue","options","label","disable"]),c(He,{modelValue:e(r).conditions,"onUpdate:modelValue":O[4]||(O[4]=y=>e(r).conditions=y),label:e(d).CONFIGURATION.PROGRAMS.LABEL.conditions,readonly:E.value,hint:e(b)("config.program.maxConditionsCount",{count:e(te)}),onEditCondition:S,onAdd:U},null,8,["modelValue","label","readonly","hint"])]),_:1},8,["label"])]),E.value?V("",!0):(f(),X("div",ea,[e(k)?V("",!0):(f(),g(L,{key:0,label:e(d).GENERAL.BUTTON.reset,class:"text-button fill-input",type:"reset","data-testid":"form-reset-btn"},null,8,["label"])),e(k)?V("",!0):(f(),g(L,{key:1,ref_key:"deleteButtonRef",ref:l,label:e(B),loading:e(_),disable:e(v),class:"text-button",color:"negative","data-testid":"form-delete-btn",onClick:e(x)},null,8,["label","loading","disable","onClick"])),c(L,{label:e($),loading:e(v),disable:e(_),class:"text-button","data-testid":"form-save-btn",color:"positive",type:"submit"},null,8,["label","loading","disable"])]))]),_:1},8,["onSubmit","onReset"])):F.value==="condition"?(f(),g(Ze,{key:1,modelValue:e(r).conditions[i.value],"onUpdate:modelValue":O[5]||(O[5]=y=>e(r).conditions[i.value]=y),readonly:E.value,title:`${e(d).CONFIGURATION.PROGRAMS.condition} ${i.value+1}`,program:e(P),onClose:Z},null,8,["modelValue","readonly","title","program"])):V("",!0)]),_:1}))}},ma={__name:"AppProgramsPage",setup(n){const N=J(),{maxElementsToast:u}=we(),b=ce(),d=p(()=>b.getters["program/programArray"]),R=p(()=>b.getters["program/PROGRAM_TREE"]),I=p(()=>b.getters["program/STATE_TREE"]),C=p(()=>R.value.map(i=>({id:i.id,marker:i.marker,label:i.label,data:i.data}))),{formId:a,leftTreeRef:r,selectedElements:s,onAdd:l,getTreeItemById:v,selectNewTreeItemIds:G,updateSelectedElements:_,selectedTreeItemIds:x}=Pe({leftTree:R,rightTree:I,add:P}),k=p(()=>Me(d.value.map(i=>i.number),D+1,Y+1));function P(){if(d.value.length>=D){u(D);return}return t(),o.value=!0,!0}function B(){M.value=!0}function $(){o.value=!1;const i=ie({...Fe("program"),number:k.value,index:null,conditions:We(0,te).map(ue)});s.value=[i]}function q(i){o.value=!1,M.value=!1;const S=v(i),U=ie({...j(S.data),number:k.value,index:null});U.conditions.forEach(Z=>Z.isNew=!0),s.value=[U]}function t(){M.value=!1}const m=w([]),o=w(!1),M=w(!1);ee([o,M],()=>{a.value++});const h=w(re[0]);function E(i){h.value=i,m.value=[]}const F=p(()=>h.value==="all"?I.value:I.value.filter(i=>i.data.group===h.value));return(i,S)=>(f(),X(ke,null,[c(e(de),{ref_key:"leftTreeRef",ref:r,selected:e(x),"onUpdate:selected":S[0]||(S[0]=U=>{o.value=!1,e(G)(U)}),onAdd:e(l),items:R.value,title:e(N).ROUTER.CONFIG.programs,"required-selection":"",searchable:"","add-button":""},null,8,["selected","onAdd","items","title"]),e(s).length||o.value||M.value?(f(),g(pe,{key:0,name:"fade",mode:"out-in"},{default:T(()=>[(f(),X("div",{class:"config-form-wrapper",key:e(a)},[o.value&&M.value?(f(),g(qe,{key:0,title:e(N).CONFIGURATION.PROGRAMS.copyProgram,items:C.value,onClose:t,onCopy:q},null,8,["title","items"])):o.value?(f(),g(Qe,{key:1,title:e(N).CONFIGURATION.PROGRAMS.addingProgram,onClose:S[1]||(S[1]=U=>o.value=!1)},{default:T(()=>[c(L,{class:"text-h3 bg-back text-primary",onClick:$},{default:T(()=>[se(ae(e(N).CONFIGURATION.PROGRAMS.addProgram),1)]),_:1}),c(L,{class:"text-h3 bg-back text-primary",onClick:B},{default:T(()=>[se(ae(e(N).CONFIGURATION.PROGRAMS.copyProgram),1)]),_:1})]),_:1},8,["title"])):(f(),g(e(aa),{key:2,elements:e(s),"onUpdate:elements":e(_)},null,8,["elements","onUpdate:elements"]))]))]),_:1})):V("",!0),c(e(de),{items:F.value,selected:m.value,"onUpdate:selected":S[2]||(S[2]=U=>m.value=U),title:e(N).GENERAL.LABEL.states,"is-right-tree":"","can-multiple-selection":"","can-selection-all-children":"",searchable:""},{header:T(()=>[c(je,{modelValue:h.value,"onUpdate:modelValue":E,class:"mb-16"},null,8,["modelValue"])]),_:1},8,["items","selected","title"])],64))}};export{ma as default};
