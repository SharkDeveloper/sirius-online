<!doctype html><meta content="width=device-width,initial-scale=1" name="viewport" /><meta
  charset="utf-8"
/><title>Сириус: Обновление web-клиента</title
><style>
  html {
    height: 100%;
  }
  body {
    margin: 0;
    height: 100%;
    text-align: center;
  }
  body:after {
    display: inline-block;
    vertical-align: middle;
    width: 0;
    height: 100%;
    content: "";
  }
  #main {
    display: inline-block;
    vertical-align: middle;
  }
  #log {
    margin-top: 15px;
    height: 1em;
  }
  .hide {
    display: none;
  }
  button {
    margin-top: 10px;
  }
  #updateButton {
    margin-left: 30px;
  }
</style>
<div id="main">
  <div id="loginForm" class="hide">
    <h1 style="margin-top: 0">Требуется авторизация!</h1>
    <label>Логин:</label><br /><input id="login" /><br /><br /><label>Пароль:</label><br /><input
      id="password"
      type="password"
    /><br /><br /><button onclick="back()" type="submit">Назад</button>
    <button onclick="send()" type="submit" id="updateButton">Отправить</button>
  </div>
  <div id="fileForm">
    <h1 style="margin-top: 0">Требуется обновление web-клиента!</h1>
    <input id="file" type="file" style="margin-top: 10px" />
    <button onclick="update()" type="submit">Обновить</button>
  </div>
  <div id="log"></div>
</div>
<script>
  function back() {
    document.getElementById("fileForm").classList.remove("hide"),
      document.getElementById("loginForm").classList.add("hide"),
      (document.getElementById("updateButton").disabled = !1);
  }
  function update() {
    document.getElementById("fileForm").classList.add("hide"),
      document.getElementById("loginForm").classList.remove("hide");
  }
  function send() {
    var e = new Date(new Date().getTime() + 3e5),
      t = 9998 * Math.random() + 1;
    t = (t += e).hashCode().toString().slice(0, -1);
    var n = new XMLHttpRequest();
    n.open("POST", "/login", !0),
      n.send(
        '{user: "' +
          document.getElementById("login").value +
          '", password: "' +
          document.getElementById("password").value +
          '", session: "' +
          t +
          '"}'
      ),
      (document.getElementById("updateButton").disabled = !0),
      (n.onreadystatechange = function () {
        n.readyState == XMLHttpRequest.DONE &&
          (200 == n.status || 303 == n.status
            ? ((n = new XMLHttpRequest()).open("POST", "/update?session=" + t, !0),
              n.setRequestHeader("Content-type", "application/octet-stream"),
              n.send(document.getElementById("file").files[0]),
              (document.getElementById("log").innerHTML =
                "Идет загрузка файла.. Пожалуйста не перезагружайте страницу"),
              (n.onreadystatechange = function () {
                n.readyState == XMLHttpRequest.DONE &&
                  (200 == n.status || 303 == n.status
                    ? window.location.reload()
                    : ((document.getElementById("log").innerHTML = "Ошибка обновления"),
                      (document.getElementById("updateButton").disabled = !1)));
              }))
            : ((document.getElementById("log").innerHTML = "Ошибка авторизации"),
              (document.getElementById("updateButton").disabled = !1)));
      });
  }
  String.prototype.hashCode = function () {
    var e = 0;
    try {
      if (0 == this.length) return e;
      for (i = 0; i < this.length; i++)
        (char = this.charCodeAt(i)), (e = (e << 5) - e + char), (e &= e);
      return e;
    } catch (e) {
      throw new Error("hashCode: " + e);
    }
  };
</script>
